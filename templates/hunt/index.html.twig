{% extends 'base.html.twig' %}

{% block title %}Recherche France Travail
{% endblock %}

{% block body %}
	{% block stylesheets %}
		{{ parent() }}
		<link rel="stylesheet" href="{{ asset('styles/hunt.css') }}">
	{% endblock %}

	<div class="hunt-container">

		<div class="search-box">
			<h2 class="search-title">ğŸ” Explorateur d'Offres</h2>

            <div class="source-selector">
                {% set currentParams = app.request.query.all %}
                
                <a href="{{ path('app_hunt', currentParams|merge({'source': 'francetravail'})) }}" 
                   class="btn {{ currentSource == 'francetravail' ? 'btn-primary' : 'btn-outline-primary' }} btn-source-ft">
                   France Travail
                </a>
                
                <a href="{{ path('app_hunt', currentParams|merge({'source': 'adzuna'})) }}" 
                   class="btn {{ currentSource == 'adzuna' ? 'btn-success' : 'btn-outline-success' }}">
                   Adzuna
                </a>
            </div>

			{{ form_start(form) }}
            {# Persist the current source in the form #}
            <input type="hidden" name="source" value="{{ currentSource }}">
            
			<div class="form-row">
				<div class="form-group">
					{{ form_label(form.keyword, null, {'label_attr': {'class': 'form-label'}}) }}
					{{ form_widget(form.keyword) }}
				</div>
				<div class="form-group">
					{{ form_label(form.location, null, {'label_attr': {'class': 'form-label'}}) }}
					{{ form_widget(form.location) }}
				</div>
				<div>
					{{ form_widget(form.rechercher) }}
				</div>
			</div>
			{{ form_end(form) }}
		</div>

		<div class="saved-jobs-container">
			<a href="{{ path('app_my_jobs') }}" class="btn-saved-jobs">
				ğŸ“‚ Voir mes candidatures sauvegardÃ©es
			</a>
		</div>

		<div class="results-count">
			{% if jobs is not empty %}
				{{ jobs|length }}
				offres trouvÃ©es
			{% endif %}
		</div>

		{% if jobs is empty %}
			<div class="empty-state-container">
				<div class="empty-state-emoji">ğŸ¤·â€â™‚ï¸</div>
				<h3>Aucune offre trouvÃ©e</h3>
				<p>Essaie de changer de mot-clÃ© ou de dÃ©partement (ex: 75, 33, 69...)</p>
			</div>
		{% else %}
			{% for job in jobs %}
				<div class="job-card">
					<div class="job-header">
						<div class="job-title">{{ job.intitule }}</div>
						<div class="job-date">
							{{ job.dateCreation | date('d/m/Y') }}
						</div>
					</div>

					<div class="company-name">
						ğŸ¢
						{{ job.entreprise.nom ?? 'Entreprise Confidentielle' }}
					</div>

					{% if job.source == 'adzuna' %}
						<span class="badge bg-success">Adzuna</span>
					{% else %}
						<span class="badge bg-primary">France Travail</span>
					{% endif %}

					<div class="tags">
						<span class="tag">ğŸ“
							{{ job.lieuTravail.libelle }}</span>
						<span class="tag">ğŸ“œ
							{{ job.typeContrat }}</span>
						{% if job.salaire.libelle is defined %}
							<span class="tag">ğŸ’°
								{{ job.salaire.libelle }}</span>
						{% endif %}
					</div>

					<p class="job-desc">
						{{ job.description | length > 300 ? job.description|slice(0, 300) ~ '...' : job.description }}
					</p>

					{# Construction intelligente du lien #}
					{# 1. On cherche le lien partenaire ou le lien pour postuler #}
					{% set jobLink = job.origineOffre.urlOrigine ?? job.contact.urlPostulation ?? null %}

					{# 2. Si on n'a rien trouvÃ©, on tente le lien France Travail #}
					{% if jobLink is null %}
						{# On vÃ©rifie si c'est un "vrai" ID France Travail (gÃ©nÃ©ralement 7 chiffres + 1 lettre, donc <= 8 caractÃ¨res) #}
						{% if job.id|length <= 8 %}
							{% set jobLink = 'https://candidat.francetravail.fr/offres/recherche/detail/' ~ job.id %}
						{% else %}
							{# Cas dÃ©sespÃ©rÃ© : C'est une offre partenaire sans lien. On renvoie vers la recherche gÃ©nÃ©rale #}
							{% set jobLink = 'https://candidat.francetravail.fr/offres/recherche' %}
						{% endif %}
					{% endif %}
					<a href="{{ path('app_job_show', {id: job.id}) }}" class="btn-link btn-details">
						ğŸ‘ï¸ Voir les dÃ©tails
					</a>
					<a href="{{ jobLink }}" target="_blank" class="btn-link">
						Voir l'offre sur France Travail &rarr;
					</a>
				</div>
			{% endfor %}
		{% endif %}
	</div>
{% endblock %}
